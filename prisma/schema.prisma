// Prisma schema for Portfolix Compass Backend - ERM ONLY
// Database: PostgreSQL (ERM Module)
// CRITICAL ARCHITECTURE DECISION:
// - MongoDB handles: Users, Employees, Company, Departments, Payroll, Offer Letters, SalaryStructures
// - PostgreSQL/Prisma handles: Attendance, Tasks, Leaves, Sync Logs
// This separation eliminates dual-database conflicts and ensures data consistency

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// NOTE: User management is MONGODB ONLY
// See: src/models/User.js (Mongoose schema)
// Prisma does NOT manage users
// Authentication happens via MongoDB
// ============================================

// ============================================
// ERM SYSTEM - Attendance Management
// ============================================
model Attendance {
  id            String   @id @default(cuid())
  mongoUserId   String   // Reference to MongoDB user (ObjectId as String)
  mongoEmployeeId String // Reference to MongoDB employee
  
  checkInTime   DateTime
  checkOutTime  DateTime?
  workHours     Float    @default(0) // Calculated hours
  status        AttendanceStatus @default(PRESENT)
  notes         String?
  location      String?
  ipAddress     String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Sync metadata
  lastSyncedAt  DateTime?
  syncAttempts  Int      @default(0)
  isSynced      Boolean  @default(false)
  
  @@index([mongoUserId])
  @@index([mongoEmployeeId])
  @@index([createdAt])
  @@unique([mongoEmployeeId, checkInTime])
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  HALF_DAY
  LEAVE
  HOLIDAY
  SICK_LEAVE
}

// ============================================
// ERM SYSTEM - Task Management
// ============================================
model Task {
  id            String   @id @default(cuid())
  mongoEmployeeId String // Assigned to (from MongoDB)
  mongoCreatedBy String  // Created by (from MongoDB)
  mongoCompanyId String   // Company context (from MongoDB)
  
  title         String
  description   String?
  priority      TaskPriority @default(MEDIUM)
  status        TaskStatus @default(PENDING)
  dueDate       DateTime?
  completedAt   DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Sync metadata
  lastSyncedAt  DateTime?
  syncAttempts  Int      @default(0)
  isSynced      Boolean  @default(false)
  
  @@index([mongoEmployeeId])
  @@index([mongoCreatedBy])
  @@index([status])
  @@index([dueDate])
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  ON_HOLD
}

// ============================================
// ERM SYSTEM - Leave Management
// ============================================
model Leave {
  id            String   @id @default(cuid())
  mongoEmployeeId String
  mongoCompanyId String
  mongoApprovedBy String?
  
  leaveType     LeaveType
  startDate     DateTime
  endDate       DateTime
  days          Int      // Number of days requested
  status        LeaveStatus @default(PENDING)
  reason        String?
  approvalNotes String?
  
  approvedAt    DateTime?
  rejectedAt    DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Sync metadata
  lastSyncedAt  DateTime?
  syncAttempts  Int      @default(0)
  isSynced      Boolean  @default(false)
  
  @@index([mongoEmployeeId])
  @@index([status])
  @@index([startDate])
}

enum LeaveType {
  ANNUAL
  SICK
  CASUAL
  MATERNITY
  PATERNITY
  UNPAID
  OTHER
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

// ============================================
// SYNC SYSTEM - MongoDB â†” PostgreSQL Sync
// ============================================
model SyncLog {
  id            String   @id @default(cuid())
  
  // Sync metadata
  entityType    String   // attendance, task, leave
  entityId      String   // Prisma ID
  mongoId       String?  // MongoDB ID (if applicable)
  mongoUserId   String   // Which MongoDB user triggered this
  mongoCompanyId String  // Which company context
  
  // Sync details
  direction     SyncDirection // MONGO_TO_PG, PG_TO_MONGO, BIDIRECTIONAL
  action        SyncAction    // CREATE, UPDATE, DELETE
  status        SyncStatus
  
  // Payload tracking
  dataSnapshot  Json?    // What was synced
  errorMessage  String?
  
  createdAt     DateTime @default(now())
  completedAt   DateTime?
  
  // Retry logic
  retryCount    Int      @default(0)
  nextRetryAt   DateTime?
  
  @@index([entityType])
  @@index([mongoCompanyId])
  @@index([status])
  @@index([createdAt])
}

enum SyncDirection {
  MONGO_TO_PG
  PG_TO_MONGO
  BIDIRECTIONAL
}

enum SyncAction {
  CREATE
  UPDATE
  DELETE
}

enum SyncStatus {
  PENDING
  IN_PROGRESS
  SUCCESS
  FAILED
  RETRY_PENDING
}

// ============================================
// AUDIT - Sync Event Tracking
// ============================================
model SyncEvent {
  id            String   @id @default(cuid())
  
  syncLogId     String   // Reference to SyncLog
  mongoUserId   String   // Who initiated
  mongoCompanyId String
  
  eventType     String   // webhook_received, sync_triggered, etc
  payload       Json?
  
  createdAt     DateTime @default(now())
  
  @@index([syncLogId])
  @@index([mongoCompanyId])
  @@index([createdAt])
}
